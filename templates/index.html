{% extends 'base.html' %}
{% block title %}{% if search_results %}Resultados da Busca{% else %}Busca de Asteroides{% endif %}{% endblock %}

{% block content %}

{% if search_results %}
    <div class="results-card">
        <div class="results-header d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h4 class="m-0">Resultados da Busca</h4>
            <div class="d-flex align-items-center gap-3">
                <span class="badge bg-light text-dark fs-6">{{ search_results|length }} encontrado(s)</span>
                <a href="{{ url_for('index') }}" class="btn btn-primary"><i class="fas fa-search me-2"></i>Nova Busca</a>
            </div>
        </div>
        <div class="p-3">
            <div class="d-flex flex-wrap gap-3 mb-3 align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <label for="table-select" class="form-label mb-0">Salvar em:</label>
                    <select id="table-select" class="form-select" style="width: auto;">
                        {% for name in saved_tables_names %}<option value="{{ name }}">{{ name }}</option>{% endfor %}
                    </select>
                    <span class="d-inline-block"
                          data-bs-toggle="popover" 
                          data-bs-trigger="hover focus"
                          tabindex="0"
                          title="Para Onde Vão os Dados?" 
                          data-bs-content="Escolha em qual das suas tabelas os dados serão salvos. Você pode ver e gerenciar todas as suas tabelas na página 'Minhas Tabelas'.">
                        <i class="fas fa-question-circle text-secondary"></i>
                    </span>
                </div>
                <div class="d-flex gap-2 ms-auto align-items-center">
                    <div id="initial-save-buttons" class="d-flex gap-2">
                        <form action="{{ url_for('add_rows_batch') }}" method="POST"><input type="hidden" name="tabela_destino" class="table-dest-input"><input type="hidden" name="objects_to_add" value="{{ search_results|map(attribute='Objeto')|join(',') }}"><button type="submit" class="btn btn-success"><i class="fas fa-save me-2"></i> Salvar Tudo</button></form>
                        <button id="enable-select-mode" type="button" class="btn btn-outline-info"><i class="fas fa-check-square me-2"></i> Salvar Linhas</button>
                    </div>

                    <span class="d-inline-block" id="save-tutorial-trigger"
                          data-bs-toggle="popover" 
                          data-bs-trigger="hover focus"
                          data-bs-html="true"
                          tabindex="0"
                          title="Como Salvar na Tabela?" 
                          data-bs-content="Use estes botões para enviar os dados para a tabela escolhida em 'Salvar em:'.<br><br><strong>Salvar Tudo:</strong> Envia todos os resultados.<br><br><strong>Salvar Linhas:</strong> Permite selecionar quais linhas enviar.">
                        <i class="fas fa-question-circle text-secondary"></i>
                    </span>

                    <div id="selection-controls" class="d-none gap-2">
                        <form id="select-form" action="{{ url_for('add_rows_batch') }}" method="POST"><input type="hidden" name="tabela_destino" class="table-dest-input"><input type="hidden" name="objects_to_add" id="selected_objects_input"><button id="save-selected-btn" type="submit" class="btn btn-info" disabled><i class="fas fa-check me-2"></i> Salvar Selecionadas</button></form>
                        <button id="cancel-select-mode" type="button" class="btn btn-secondary">Cancelar</button>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info alert-dismissible fade show" id="config-alert" role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-cogs fa-lg me-3"></i>
                    <div><strong>Dica:</strong> Não gostou da visualização? Você pode escolher quais colunas exibir e reordená-las na página de <a href="{{ url_for('configuracoes') }}" class="alert-link">Configurações</a>.</div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <p id="selection-instruction" class="selection-instruction text-center mb-3 d-none"><i class="fas fa-mouse-pointer"></i> Clique nas linhas ou marque as caixas para selecionar.</p>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead><tr><th class="selection-col"><i class="fas fa-check"></i></th>{% for col in visible_cols %}<th>{{ col }}</th>{% endfor %}</tr></thead>
                    <tbody id="results-tbody">
                        {% for row in search_results %}<tr data-object-name="{{ row.get('Objeto') }}"><td class="selection-col"><input class="form-check-input row-checkbox" type="checkbox"></td>{% for col in visible_cols %}<td>{{ row.get(col, '-') }}</td>{% endfor %}</tr>{% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

{% else %}
    <div class="main-card mx-auto">
        <div class="text-center mb-4">
            <h1 class="display-5 fw-bold">Busca de Asteroides</h1>
            <p class="text-secondary">Insira os identificadores para iniciar a busca.</p>
        </div>
        <form id="search-form" method="POST" action="{{ url_for('run_search') }}">
            <div class="mb-3">
                <textarea class="form-control" name="identificadores" id="identificadores" rows="8" 
                          placeholder="A busca funciona com códigos de asteroides preliminares. Cole um ou mais códigos na caixa de texto, um por linha.&#10;&#10;Exemplos de códigos válidos:&#10;IUc7254&#10;P11jMkA&#10;P21ESwb" 
                          required>{{ session.get('previous_input', '') }}</textarea>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-search me-2"></i> Buscar</button>
            </div>
        </form>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/search_manager.js') }}"></script>
{% endblock %}