{% extends 'base.html' %}
{% block title %}Minhas Tabelas{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="display-5">Minhas Tabelas</h1>
    <form action="/reanalisar" method="POST">
        <button type="submit" class="btn btn-warning">Reanalisar Tabela Ativa</button>
    </form>
</div>

<ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="pills-view-tab" data-bs-toggle="pill" data-bs-target="#pills-view" type="button" role="tab">Exibir Tabelas</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pills-create-tab" data-bs-toggle="pill" data-bs-target="#pills-create" type="button" role="tab">Criar Nova Tabela</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pills-manage-tab" data-bs-toggle="pill" data-bs-target="#pills-manage" type="button" role="tab">Gerenciar Tabela Ativa</button>
    </li>
</ul>

<div class="tab-content config-box" id="pills-tabContent">
    <div class="tab-pane fade show active" id="pills-view" role="tabpanel">
        <form method="GET" action="{{ url_for('minhas_tabelas') }}" class="row g-3 align-items-center">
            <div class="col-auto">
                <label for="active_table_selector" class="col-form-label"><b>Visualizando a Tabela:</b></label>
            </div>
            <div class="col-auto">
                <select class="form-select" name="active_table" id="active_table_selector" onchange="this.form.submit()">
                    {% for name in saved_tables_names %}
                        <option value="{{ name }}" {% if name == active_table_name %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>

    <div class="tab-pane fade" id="pills-create" role="tabpanel">
        <h4>Criar uma Nova Tabela</h4>
        <form action="/create-table" method="POST" class="row g-3 align-items-center mt-2">
            <div class="col-auto"><input type="text" name="new_name" class="form-control" placeholder="Nome da nova tabela" required></div>
            <div class="col-auto"><button type="submit" class="btn btn-primary">Criar</button></div>
        </form>
    </div>

    <div class="tab-pane fade" id="pills-manage" role="tabpanel">
        <h4>Gerenciando a Tabela: <strong>{{ active_table_name }}</strong></h4>
        <hr>
        <div class="mb-3">
            <h5>Renomear Tabela</h5>
            <form action="/rename-table" method="POST" class="row g-3 align-items-center">
                 <div class="col-auto"><input type="text" name="new_name" class="form-control" placeholder="Novo nome para '{{ active_table_name }}'" required></div>
                 <div class="col-auto"><button type="submit" class="btn btn-secondary">Renomear</button></div>
            </form>
        </div>
        <hr>
        <div class="mb-3">
             <h5>Excluir Tabela Inteira</h5>
            <form action="/delete-table" method="POST" onsubmit="return confirm('Tem certeza que deseja excluir a tabela \'{{ active_table_name }}\'? Esta a√ß√£o n√£o pode ser desfeita.');">
                 <button type="submit" class="btn btn-danger">Excluir a tabela '{{ active_table_name }}'</button>
            </form>
        </div>
        <hr>
        <h5>Editar Conte√∫do da Tabela</h5>
        <div id="edit-mode-controls">
            <button id="enter-delete-mode" class="btn btn-outline-danger">Excluir Linhas</button>
            <button id="enter-reorder-mode" class="btn btn-outline-primary">Reordenar Linhas</button>
            
            <div id="edit-buttons" class="mt-2" style="display: none;">
                <form id="delete-form" action="/delete-rows" method="POST" style="display: none;">
                    <input type="hidden" name="objects_to_delete" id="objects_to_delete">
                    <button type="submit" class="btn btn-success">Salvar Exclus√µes</button>
                </form>
                <form id="reorder-form" action="/reorder-rows" method="POST" style="display: none;">
                    <input type="hidden" name="ordered_objects" id="ordered_objects">
                    <button type="submit" class="btn btn-success">Salvar Ordem</button>
                </form>
                <button id="cancel-edit-mode" class="btn btn-secondary">Cancelar Edi√ß√£o</button>
            </div>
        </div>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
    <div class="alert alert-{{ messages[0][0] }} mt-4 text-center">
      {{ messages[0][1] }}
    </div>
{% endif %}
{% endwith %}
{% with notifications = session.pop('notifications', None) %}
{% if notifications %}
<div class="alert alert-info mt-4">
    <h4>üîî Notifica√ß√µes da Rean√°lise:</h4>
    <ul>
        {% for note in notifications %}
        <li>{{ note|safe }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}
{% endwith %}

{% if table_html %}
    <h3 class="mt-4">Conte√∫do de: {{ active_table_name }}</h3>
    <div class="table-container config-box mt-3">
        <div id="main-table-wrapper">
             {{ table_html|safe }}
        </div>
    </div>
{% else %}
    <div class="config-box text-center mt-4">
        <p>A tabela '{{ active_table_name }}' est√° vazia.</p>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tableWrapper = document.getElementById('main-table-wrapper');
    const table = tableWrapper ? tableWrapper.querySelector('table') : null;
    if (!table) return;

    // --- Controles Gerais ---
    const enterDeleteBtn = document.getElementById('enter-delete-mode');
    const enterReorderBtn = document.getElementById('enter-reorder-mode');
    const cancelEditBtn = document.getElementById('cancel-edit-mode');
    const editButtonsDiv = document.getElementById('edit-buttons');
    
    const deleteForm = document.getElementById('delete-form');
    const reorderForm = document.getElementById('reorder-form');
    
    let sortableInstance = null;
    let rowsToDelete = new Set();

    function enterEditMode() {
        enterDeleteBtn.style.display = 'none';
        enterReorderBtn.style.display = 'none';
        editButtonsDiv.style.display = 'block';
    }
    
    // --- L√≥gica para entrar no modo de EXCLUS√ÉO ---
    enterDeleteBtn.addEventListener('click', function() {
        enterEditMode();
        deleteForm.style.display = 'inline-block';
        
        table.querySelectorAll('tbody tr').forEach(row => {
            const objectName = row.cells[0].textContent;
            const actionCell = row.insertCell(0);
            actionCell.style.width = '60px';
            actionCell.style.textAlign = 'center';
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'X';
            deleteBtn.className = 'btn btn-danger btn-sm';
            deleteBtn.onclick = () => {
                if (rowsToDelete.has(objectName)) {
                    rowsToDelete.delete(objectName);
                    row.style.textDecoration = '';
                } else {
                    rowsToDelete.add(objectName);
                    row.style.textDecoration = 'line-through';
                }
            };
            actionCell.appendChild(deleteBtn);
        });
        const headerRow = table.querySelector('thead tr');
        if (headerRow) {
            const th = document.createElement('th');
            th.textContent = 'A√ß√£o';
            headerRow.insertBefore(th, headerRow.firstChild);
        }
    });

    // --- L√≥gica para entrar no modo de REORDENA√á√ÉO ---
    enterReorderBtn.addEventListener('click', function() {
        enterEditMode();
        reorderForm.style.display = 'inline-block';

        const tbody = table.querySelector('tbody');
        sortableInstance = new Sortable(tbody, {
            animation: 150,
            handle: '.handle', 
        });
        
        table.querySelectorAll('tbody tr').forEach(row => {
            const actionCell = row.insertCell(0);
            actionCell.style.width = '60px';
            actionCell.style.textAlign = 'center';
            actionCell.innerHTML = '<span class="handle" style="cursor: move;">‚ò∞</span>';
        });
        const headerRow = table.querySelector('thead tr');
        if (headerRow) {
            const th = document.createElement('th');
            th.textContent = 'Mover';
            headerRow.insertBefore(th, headerRow.firstChild);
        }
    });

    // --- Fun√ß√µes Comuns ---
    cancelEditBtn.addEventListener('click', () => window.location.reload());

    deleteForm.addEventListener('submit', () => {
        document.getElementById('objects_to_delete').value = Array.from(rowsToDelete).join(',');
    });

    reorderForm.addEventListener('submit', () => {
        const orderedObjects = Array.from(table.querySelectorAll('tbody tr')).map(row => {
            // A c√©lula do nome do objeto √© a segunda (√≠ndice 1) porque a de Mover foi inserida na primeira (√≠ndice 0)
            return row.cells[1].textContent;
        });
        document.getElementById('ordered_objects').value = orderedObjects.join(',');
    });
});
</script>
{% endblock %} ```

### O que Fazer

Agora, basta atualizar o site que est√° no ar com esta corre√ß√£o.

1.  **Pare o servidor** local (`Ctrl+C`), se ele estiver rodando.
2.  Substitua o conte√∫do do seu arquivo `templates/minha_tabela.html` local.
3.  **Salve** o arquivo.
4.  Use o **CMD** para enviar a atualiza√ß√£o para o GitHub, com os 3 comandos:

    ```cmd
    cd Desktop\Site_Asteroides
    git add .
    git commit -m "Corrige erro de template em minhas_tabelas.html"
    git push origin main
    ```
Depois de alguns minutos, o Render vai atualizar o site e o erro "Internal Server Error" desaparecer√°.