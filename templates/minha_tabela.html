{% extends 'base.html' %}
{% block title %}Minhas Tabelas{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-4">
    <h1 class="display-5 fw-bold m-0">Minhas Tabelas</h1>
</div>

<div class="alert alert-info alert-dismissible fade show" id="manage-tables-alert" role="alert">
    <div class="d-flex align-items-center">
        <i class="fas fa-info-circle fa-lg me-3"></i>
        <div>
            <strong>Dica:</strong> Precisa de mais organização? Otimize seu trabalho criando tabelas separadas. Use o menu 'Gerenciar...' para criar, renomear ou excluir suas áreas de análise.
        </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div class="main-card mx-auto mb-4" id="management-panel">
    <div class="d-flex flex-wrap gap-3 align-items-center">
        <div class="d-flex align-items-center gap-2">
            <label for="active_table_select" class="form-label mb-0 text-nowrap fw-bold fs-5">Tabela Ativa:</label>
            <select id="active_table_select" class="form-select"></select>
        </div>
        <div class="ms-auto d-flex align-items-center gap-2">
             <button class="btn btn-warning" type="button" data-bs-toggle="collapse" data-bs-target="#management-options"><i class="fas fa-cog me-2"></i>Gerenciar...</button>
             <span class="d-inline-block" data-bs-toggle="popover" data-bs-trigger="click" data-bs-html="true" tabindex="0" title="Painel de Controle" data-bs-content="Clique para ver todas as ações para a tabela selecionada."><i class="fas fa-question-circle text-secondary fs-4"></i></span>
        </div>
    </div>
    <div class="collapse mt-3" id="management-options">
        <hr>
        <h6 class="text-secondary text-uppercase small mt-3">Ações da Tabela</h6>
        <div class="d-flex flex-wrap gap-2 pt-2">
            <span data-bs-toggle="popover" data-bs-trigger="click" data-bs-placement="bottom" title="Criar Nova Tabela" data-bs-content="Abre uma janela para criar uma nova tabela vazia.">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createTableModal"><i class="fas fa-plus me-2"></i>Criar Nova</button>
            </span>
            <span data-bs-toggle="popover" data-bs-trigger="click" data-bs-placement="bottom" title="Renomear Tabela Ativa" data-bs-content="Permite alterar o nome da tabela que está selecionada.">
                <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#renameTableModal"><i class="fas fa-edit me-2"></i>Renomear Tabela</button>
            </span>
            <span data-bs-toggle="popover" data-bs-trigger="click" data-bs-placement="bottom" title="Excluir Tabela Ativa" data-bs-content="Apaga permanentemente a tabela selecionada. Cuidado, esta ação não pode ser desfeita!">
                <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteTableModal"><i class="fas fa-times-circle me-2"></i>Excluir Tabela</button>
            </span>
        </div>
        <hr>
        <h6 class="text-secondary text-uppercase small mt-3">Ações no Conteúdo</h6>
        <div class="d-flex flex-wrap gap-2 pt-2">
            <span data-bs-toggle="popover" data-bs-trigger="click" data-bs-placement="bottom" title="Personalizar Colunas" data-bs-content="Abre a página de Configurações para escolher quais colunas exibir e reordená-las.">
                <a href="{{ url_for('configuracoes') }}" class="btn btn-outline-light"><i class="fas fa-columns me-2"></i>Personalizar Colunas</a>
            </span>
            <span data-bs-toggle="popover" data-bs-trigger="click" data-bs-placement="bottom" title="Organizar Linhas" data-bs-content="Ativa o modo de arrastar e soltar para reordenar as linhas da tabela.">
                <button id="reorder-rows-btn" class="btn btn-outline-info"><i class="fas fa-arrows-alt-v me-2"></i>Organizar Linhas</button>
            </span>
            <span data-bs-toggle="popover" data-bs-trigger="click" data-bs-placement="bottom" title="Excluir Linhas" data-bs-content="Ativa o modo de seleção para remover linhas específicas da tabela.">
                <button id="enable-delete-mode" class="btn btn-outline-danger"><i class="fas fa-trash-alt me-2"></i>Excluir Linhas</button>
            </span>
        </div>
    </div>
</div>

<div class="results-card">
    <div class="results-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h4 class="m-0">Conteúdo: <span class="text-info dynamic-active-table-name"></span></h4>
        <div class="d-flex gap-2 align-items-center">
            <span data-bs-toggle="popover" data-bs-trigger="click" data-bs-placement="top" title="Reanalisar Dados" data-bs-content="Busca novamente os dados mais recentes para todos os objetos nesta tabela. As informações antigas serão substituídas.">
                <form id="reanalyze-form" onsubmit="return false;">
                    <button type="submit" class="btn btn-success"><i class="fas fa-sync-alt me-2"></i>Reanalisar</button>
                </form>
            </span>
            <button id="download-csv-btn" class="btn btn-outline-success"><i class="fas fa-download me-2"></i>Baixar</button>
        </div>
    </div>
    <div class="p-3">
        <div id="reorder-controls" class="alert alert-warning d-none flex-wrap gap-2 align-items-center"><i class="fas fa-arrows-alt me-2"></i><strong>Modo de Reordenação:</strong> Arraste as linhas.<div class="ms-auto d-flex gap-2"><button id="save-reorder-btn" class="btn btn-success"><i class="fas fa-check me-2"></i>Salvar Ordem</button><button id="cancel-reorder-btn" class="btn btn-secondary">Cancelar</button></div></div>
        <div id="delete-controls" class="alert alert-danger d-none flex-wrap gap-2 align-items-center"><i class="fas fa-exclamation-triangle me-2"></i><strong>Modo de Exclusão:</strong> Marque as linhas.<div class="ms-auto d-flex gap-2"><form id="delete-rows-form" onsubmit="return false;"><button id="confirm-delete-btn" type="submit" class="btn btn-danger" disabled><i class="fas fa-trash-alt me-2"></i>Excluir</button></form><button id="cancel-delete-mode" class="btn btn-secondary">Cancelar</button></div></div>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead><tr id="table-head-row"></tr></thead>
                <tbody id="table-body-sortable"></tbody>
            </table>
        </div>
        <div id="empty-table-message" class="text-center p-5 d-none">
            <p class="text-secondary">Esta tabela está vazia.</p>
            <p class="small text-secondary">Vá para a página de <a href="{{ url_for('index') }}" class="link-light">Busca</a> para encontrar e salvar novos asteroides.</p>
        </div>
    </div>
</div>

<div class="modal fade" id="createTableModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Criar Nova Tabela</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><label for="new_name_create_input" class="form-label">Nome da Nova Tabela:</label><input type="text" id="new_name_create_input" class="form-control" required></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" id="confirm-create-table" class="btn btn-success">Criar</button></div>
    </div></div>
</div>
<div class="modal fade" id="renameTableModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Renomear Tabela</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><p>Renomear tabela: <strong class="text-info dynamic-active-table-name"></strong></p><label for="new_name_rename_input" class="form-label">Novo nome:</label><input type="text" id="new_name_rename_input" class="form-control" required></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" id="confirm-rename-table" class="btn btn-warning">Renomear</button></div>
    </div></div>
</div>
<div class="modal fade" id="deleteTableModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Excluir Tabela</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><p>Você está prestes a excluir permanentemente a tabela <strong class="text-danger dynamic-active-table-name"></strong>.</p><p class="fw-bold">Esta ação não pode ser desfeita.</p></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" id="confirm-delete-table" class="btn btn-danger">Sim, Excluir</button></div>
    </div></div>
</div>

<div class="loading-overlay" id="loading-overlay" style="display: none;">
    <div class="progress-container"><h4 class="progress-title" id="progress-title">Processando...</h4></div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script src="{{ url_for('static', filename='js/minhas_tabelas_manager.js') }}"></script>
{% endblock %}