{% extends 'base.html' %}
{% block title %}Minhas Tabelas{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="display-5">Minhas Tabelas</h1>
    <form action="/reanalisar" method="POST">
        <button type="submit" class="btn btn-warning">Reanalisar Tabela Ativa</button>
    </form>
</div>

<div class="config-box mb-4">
    <form method="GET" action="{{ url_for('minhas_tabelas') }}" class="row g-3 align-items-center">
        <div class="col-auto">
            <label for="active_table_selector" class="col-form-label"><b>Visualizando a Tabela:</b></label>
        </div>
        <div class="col-auto">
            <select class="form-select" name="active_table" id="active_table_selector" onchange="this.form.submit()">
                {% for name in saved_tables_names %}
                    <option value="{{ name }}" {% if name == active_table_name %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
            </select>
        </div>
    </form>
</div>

<div class="config-box mb-5">
    <h3 class="mb-3">Gerenciar Tabela Ativa</h3>
    <div class="accordion" id="managementAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseManageNames">
                    Criar / Renomear Tabelas
                </button>
            </h2>
            <div id="collapseManageNames" class="accordion-collapse collapse">
                <div class="accordion-body">
                    <form action="/create-table" method="POST" class="row g-3 align-items-center mb-3">
                        <div class="col-auto"><label>Nova Tabela:</label></div>
                        <div class="col-auto"><input type="text" name="new_name" class="form-control form-control-sm" placeholder="Nome da nova tabela"></div>
                        <div class="col-auto"><button type="submit" class="btn btn-primary btn-sm">Criar</button></div>
                    </form>
                    <hr>
                    <form action="/rename-table" method="POST" class="row g-3 align-items-center">
                         <div class="col-auto"><label>Renomear '{{ active_table_name }}' para:</label></div>
                         <div class="col-auto"><input type="text" name="new_name" class="form-control form-control-sm" placeholder="Novo nome"></div>
                         <div class="col-auto"><button type="submit" class="btn btn-secondary btn-sm">Renomear</button></div>
                    </form>
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseActions">
                    A√ß√µes Destrutivas
                </button>
            </h2>
            <div id="collapseActions" class="accordion-collapse collapse">
                <div class="accordion-body">
                    <div id="delete-mode-controls" class="mb-3 border-bottom pb-3">
                         <p class="mb-1"><b>Excluir Linhas:</b> Entra no modo de edi√ß√£o para remover linhas espec√≠ficas da tabela '{{ active_table_name }}'.</p>
                        <button id="enter-edit-mode" class="btn btn-danger btn-sm">Editar Linhas</button>
                        <div id="edit-buttons" style="display: none;">
                            <form id="delete-form" action="/delete-rows" method="POST" style="display: inline;">
                                <input type="hidden" name="objects_to_delete" id="objects_to_delete">
                                <button type="submit" class="btn btn-success btn-sm">Salvar Exclus√µes</button>
                            </form>
                            <button id="cancel-edit-mode" class="btn btn-secondary btn-sm">Cancelar</button>
                        </div>
                    </div>
                    <form action="/delete-table" method="POST" onsubmit="return confirm('Tem certeza que deseja excluir a tabela \'{{ active_table_name }}\'? Esta a√ß√£o n√£o pode ser desfeita.');" class="mt-3">
                        <p class="mb-1"><b>Excluir Tabela Inteira:</b> Apaga permanentemente a tabela '{{ active_table_name }}' e todo o seu conte√∫do.</p>
                         <button type="submit" class="btn btn-danger">Excluir Tabela</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
    <div class="alert alert-{{ messages[0][0] }} mt-4 text-center">
      {{ messages[0][1] }}
    </div>
{% endif %}
{% endwith %}
{% with notifications = session.pop('notifications', None) %}
{% if notifications %}
<div class="alert alert-info mt-4">
    <h4>üîî Notifica√ß√µes da Rean√°lise:</h4>
    <ul>
        {% for note in notifications %}
        <li>{{ note|safe }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}
{% endwith %}

{% if table_html %}
    <h3 class="mt-4">Conte√∫do de: {{ active_table_name }}</h3>
    <div class="table-container config-box mt-3">
        <div id="main-table-wrapper">
             {{ table_html|safe }}
        </div>
    </div>
{% else %}
    <div class="config-box text-center mt-4">
        <p>A tabela '{{ active_table_name }}' est√° vazia.</p>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// O JavaScript desta p√°gina permanece o mesmo da vers√£o anterior
document.addEventListener('DOMContentLoaded', function() {
    const tableWrapper = document.getElementById('main-table-wrapper');
    const table = tableWrapper ? tableWrapper.querySelector('table') : null;
    if (!table) return;

    const enterEditBtn = document.getElementById('enter-edit-mode');
    const cancelEditBtn = document.getElementById('cancel-edit-mode');
    const editButtonsDiv = document.getElementById('edit-buttons');
    const deleteForm = document.getElementById('delete-form');
    const objectsToDeleteInput = document.getElementById('objects_to_delete');
    
    let rowsToDelete = new Set();

    if (enterEditBtn) {
        enterEditBtn.addEventListener('click', function() {
            this.style.display = 'none';
            editButtonsDiv.style.display = 'block';
            
            table.querySelectorAll('tbody tr').forEach((row) => {
                const objectNameCell = row.cells[0];
                if (!objectNameCell) return;
                const objectName = objectNameCell.textContent;

                const actionCell = row.insertCell(0);
                actionCell.style.width = '60px';
                actionCell.style.textAlign = 'center';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'X';
                deleteBtn.className = 'btn btn-danger btn-sm';

                deleteBtn.addEventListener('click', function() {
                    if (rowsToDelete.has(objectName)) {
                        rowsToDelete.delete(objectName);
                        row.style.textDecoration = '';
                        row.style.opacity = '1';
                    } else {
                        rowsToDelete.add(objectName);
                        row.style.textDecoration = 'line-through';
                        row.style.opacity = '0.6';
                    }
                });
                actionCell.appendChild(deleteBtn);
            });

            const headerRow = table.querySelector('thead tr');
            if (headerRow) {
                const th = document.createElement('th');
                th.textContent = 'A√ß√£o';
                th.style.width = '60px';
                headerRow.insertBefore(th, headerRow.firstChild);
            }
        });
    }

    if (cancelEditBtn) {
        cancelEditBtn.addEventListener('click', function() {
            window.location.reload();
        });
    }

    if (deleteForm) {
        deleteForm.addEventListener('submit', function(event) {
            objectsToDeleteInput.value = Array.from(rowsToDelete).join(',');
        });
    }
});
</script>
{% endblock %}